<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.scoula.map.mapper.MapMapper">

    <select id="getAddressList" resultType="org.scoula.map.domain.MapVO">
        #최신 데이터 순으로 실거래가 전체 보여주기
        select pl.location_no, pl.road_name, pl.x_coordinate, pl.y_coordinate, pl.recent_price
        from property_location pl
        right join property_tbl pr
        on pl.location_no = pr.location_no
        WHERE property_doro_juso in (SELECT property_doro_juso FROM property_tbl
                                     group by property_doro_juso
                                     HAVING COUNT(property_doro_juso) > 1)
    </select>

    <select id="getAddressDetails" resultType="org.scoula.map.domain.MapDetailDTO">
        select
            pl.location_no,
            pr.property_no,
            pl.road_name,
            pr.price,
            pr.formated_date AS date,
            pr.property_area,
            pr.property_addr_apt_dong,
            pr.property_addr_floor,
            pr.building_year,
            pr.contract_year_month,
            pr.contract_date,
            pr.property_addr_apt_name,
            pr.contract_type,
            pr.property_jibun_juso
        from property_location as pl
        right outer join property_tbl as pr
        on pl.location_no = pr.location_no
        where pl.location_no = #{id}
    </select>

    <select id="getAddressListMove" resultType="org.scoula.map.domain.MapVO">
        SELECT
            pl.location_no,
            pl.road_name AS doro_juso,
            pl.x_coordinate,
            pl.y_coordinate,
            pr.formated_price as price
        FROM property_location pl
                 INNER JOIN property_tbl pr ON pl.location_no = pr.location_no
                 INNER JOIN zoom_levels zl ON zl.zoom_level = #{zoomLevel}
        WHERE pl.y_coordinate BETWEEN (#{lat} - zl.lat_range / 2) AND (#{lat} + zl.lat_range / 2)
          AND pl.x_coordinate BETWEEN (#{lon} - zl.lon_range / 2) AND (#{lon} + zl.lon_range / 2)
          AND pr.formated_date = (
            SELECT MAX(pr2.formated_date)FROM property_tbl pr2
            WHERE pr2.location_no = pl.location_no)
    </select>

    <select id="getAddressListMoveCluster" resultType="org.scoula.map.domain.MapVO">
        SELECT
            pl.location_no,
            pl.road_name AS doro_juso,
            pl.x_coordinate,
            pl.y_coordinate
        FROM property_location pl
                 INNER JOIN zoom_levels zl ON zl.zoom_level = #{zoomLevel}
        WHERE pl.y_coordinate BETWEEN (#{lat} - zl.lat_range ) AND (#{lat} + zl.lat_range )
          AND pl.x_coordinate BETWEEN (#{lon} - zl.lon_range ) AND (#{lon} + zl.lon_range )
    </select>
</mapper>
